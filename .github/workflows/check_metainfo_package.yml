name: nexus package check

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  # Run workflow only when there are changes in src/pynxtools/nomad or in the definitions submodule
    # paths:
    #   - 'src/pynxtools/nomad'
    #   - 'src/pynxtools/definitions'

env:
  python-version: 3.11

jobs:
  nexus-version:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: recursive
      - name: Install uv and set the python version to ${{ env.python-version }}
        uses: astral-sh/setup-uv@v5
        with:
          python-version: ${{ env.python-version }}
      - name: Install nomad
        run: |
          uv pip install 'nomad-lab[infrastructure] @ git+https://gitlab.mpcdf.mpg.de/nomad-lab/nomad-FAIR.git@tlc/ensure-identical-section'
      - name: Install pynx
        run: |
          uv pip install .
      - name: Generate metainfo package
        run: |
          ./scripts/generate_package.sh
      - uses: CatChen/check-git-status-action@v1
        with:
          fail-if-not-clean: true
          request-changes-if-not-clean: false
          push-if-not-clean: false
      - name: git diff
        if: failure()
        run: git diff src/pynxtools/nomad/nxs_metainfo_package.json